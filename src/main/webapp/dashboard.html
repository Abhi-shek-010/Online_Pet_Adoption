<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PawMatch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: {
                            50: '#fff7ed', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74',
                            400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-item.active {
            background-color: #fff7ed;
            color: #ea580c;
            border-right: 3px solid #ea580c;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .soft-hover:hover {
            transform: translateY(-2px);
            transition: transform 0.2s;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-800 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 glass-sidebar hidden md:flex flex-col z-20 shadow-xl">
        <div class="h-20 flex items-center px-8 border-b border-gray-100 cursor-pointer"
            onclick="window.location.href='index.html'">
            <div class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white mr-3">
                <i class="fas fa-paw"></i>
            </div>
            <span class="text-xl font-bold tracking-tight">PawMatch</span>
        </div>

        <div class="flex-1 py-6 space-y-1">
            <p class="px-8 text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Menu</p>
            <a href="#" onclick="switchTab('overview')" id="nav-overview"
                class="nav-item active flex items-center px-8 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
                <i class="fas fa-th-large w-6"></i> Overview
            </a>
            <a href="#" onclick="switchTab('applications')" id="nav-applications"
                class="nav-item flex items-center px-8 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
                <i class="fas fa-file-alt w-6"></i> Applications
            </a>
            <!-- Conditional specific items could go here -->
            <a href="pets-listing.html"
                class="nav-item flex items-center px-8 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition">
                <i class="fas fa-search w-6"></i> Browse Pets
            </a>
        </div>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 font-bold"
                    id="userAvatar">
                    U
                </div>
                <div>
                    <h4 class="text-sm font-bold truncate w-32" id="userNameDisplay">User</h4>
                    <p class="text-xs text-gray-500 capitalize" id="userRoleDisplay">Role</p>
                </div>
            </div>
            <button onclick="logout()"
                class="mt-4 w-full py-2 border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:bg-gray-50 transition">
                Log Out
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto relative custom-scroll">
        <!-- Header -->
        <header
            class="h-20 bg-white/80 backdrop-blur sticky top-0 z-10 border-b border-gray-100 px-8 flex justify-between items-center">
            <h2 class="text-xl font-bold" id="pageTitle">Dashboard</h2>
            <div class="flex gap-4">
                <button
                    class="w-10 h-10 rounded-full border border-gray-200 flex items-center justify-center text-gray-400 hover:text-orange-500 hover:border-orange-500 transition">
                    <i class="far fa-bell"></i>
                </button>
            </div>
        </header>

        <div class="p-8 max-w-6xl mx-auto animate-fade-in-up">

            <!-- OVERVIEW TAB -->
            <div id="view-overview" class="space-y-8">
                <!-- Welcome Banner -->
                <div class="bg-gradient-to-r from-orange-500 to-red-600 rounded-3xl p-8 text-white relative overflow-hidden card-shadow"
                    data-tilt data-tilt-max="2" data-tilt-speed="400">
                    <div class="relative z-10 w-2/3">
                        <h1 class="text-3xl font-bold mb-2">Welcome Back, <span id="welcomeName">User</span>!</h1>
                        <p class="text-orange-100 opacity-90">Here's what's happening with your adoption journey today.
                        </p>
                        <button onclick="switchTab('applications')"
                            class="mt-6 px-6 py-2 bg-white text-orange-600 rounded-full font-bold text-sm hover:bg-orange-50 transition shadow-lg">
                            View Activity
                        </button>
                    </div>
                    <!-- Decorative particles -->
                    <div class="absolute right-0 top-0 opacity-10 text-9xl transform translate-x-10 -translate-y-10"><i
                            class="fas fa-paw"></i></div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 card-shadow soft-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-400">PENDING</span>
                        </div>
                        <div class="text-3xl font-bold mb-1" id="statPending">0</div>
                        <p class="text-xs text-gray-400">Applications awaiting review</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 card-shadow soft-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-green-50 text-green-500 flex items-center justify-center">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-400">APPROVED</span>
                        </div>
                        <div class="text-3xl font-bold mb-1" id="statApproved">0</div>
                        <p class="text-xs text-gray-400">Successful adoptions</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 card-shadow soft-hover">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-purple-50 text-purple-500 flex items-center justify-center">
                                <i class="fas fa-heart"></i>
                            </div>
                            <span class="text-xs font-bold text-gray-400">SAVED</span>
                        </div>
                        <div class="text-3xl font-bold mb-1" id="statSaved">0</div>
                        <p class="text-xs text-gray-400">Lives changed forever</p>
                    </div>
                </div>
            </div>

            <!-- APPLICATIONS TAB -->
            <div id="view-applications" class="hidden space-y-6">
                <!-- Applications List -->
                <div class="bg-white rounded-3xl border border-gray-100 overflow-hidden card-shadow">
                    <div class="p-6 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-lg text-gray-800">Application History</h3>
                        <div class="flex gap-2">
                            <select class="text-xs border border-gray-200 rounded-lg px-2 py-1 outline-none">
                                <option>All Status</option>
                                <option>Pending</option>
                                <option>Approved</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr
                                    class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-gray-50 bg-gray-50/50">
                                    <th class="p-4 pl-6">ID</th>
                                    <th class="p-4">Pet ID</th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsTableBody" class="text-sm">
                                <!-- JS Injection -->
                                <tr>
                                    <td colspan="5" class="p-8 text-center text-gray-400">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const userId = sessionStorage.getItem('userId');
        const role = sessionStorage.getItem('userRole');
        const userName = sessionStorage.getItem('userName');

        if (!userId) window.location.href = 'login.html';

        // Init UI
        document.getElementById('userNameDisplay').innerText = userName || 'User';
        document.getElementById('welcomeName').innerText = userName || 'Friend';
        document.getElementById('userRoleDisplay').innerText = role || 'Member';
        document.getElementById('userAvatar').innerText = (userName ? userName[0] : 'U').toUpperCase();

        function switchTab(tabId) {
            // Update Title
            document.getElementById('pageTitle').innerText = tabId.charAt(0).toUpperCase() + tabId.slice(1);

            // Toggle Views
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');

            // Toggle Nav Active
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            if (tabId === 'applications') fetchApplications();
        }

        function fetchApplications() {
            let url = role === 'SHELTER' || role === 'ADMIN'
                ? '/api/applications/shelter'
                : '/api/applications/my';

            fetch(url)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('applicationsTableBody');
                    tbody.innerHTML = '';

                    if (data.success && data.applications.length > 0) {
                        // Update Stats
                        const pending = data.applications.filter(a => a.status === 'PENDING').length;
                        const approved = data.applications.filter(a => a.status === 'APPROVED').length;
                        document.getElementById('statPending').innerText = pending;
                        document.getElementById('statApproved').innerText = approved;

                        data.applications.forEach(app => {
                            const tr = document.createElement('tr');
                            tr.className = 'border-b border-gray-50 hover:bg-gray-50/50 transition';

                            let statusColor = 'bg-gray-100 text-gray-600';
                            if (app.status === 'APPROVED') statusColor = 'bg-green-50 text-green-600';
                            if (app.status === 'REJECTED') statusColor = 'bg-red-50 text-red-600';
                            if (app.status === 'PENDING') statusColor = 'bg-blue-50 text-blue-600';

                            let actions = '-';
                            if (role === 'SHELTER' && app.status === 'PENDING') {
                                actions = `
                                <div class="flex gap-2">
                                    <button onclick="approve(${app.applicationId})" class="p-1.5 rounded-lg text-green-600 hover:bg-green-100 transition" title="Approve"><i class="fas fa-check"></i></button>
                                    <button onclick="reject(${app.applicationId})" class="p-1.5 rounded-lg text-red-600 hover:bg-red-100 transition" title="Reject"><i class="fas fa-times"></i></button>
                                </div>
                            `;
                            } else if (app.status === 'REJECTED') {
                                actions = `<span class="text-xs text-gray-400">Closed</span>`;
                            }

                            tr.innerHTML = `
                            <td class="p-4 pl-6 font-bold text-gray-500">#${app.applicationId}</td>
                            <td class="p-4 text-orange-600 font-bold">#${app.petId}</td>
                            <td class="p-4 text-gray-500">${new Date(app.applicationDate).toLocaleDateString()}</td>
                            <td class="p-4"><span class="px-3 py-1 rounded-full text-xs font-bold ${statusColor}">${app.status}</span></td>
                            <td class="p-4">${actions}</td>
                        `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-400">No applications found.</td></tr>';
                    }
                })
                .catch(e => console.error(e));
        }

        function approve(id) {
            if (!confirm("Approve this adoption? This will finalize the record.")) return;
            updateStatus(id, 'approve');
        }

        function reject(id) {
            if (!confirm("Reject this application?")) return;
            updateStatus(id, 'reject');
        }

        function updateStatus(id, action) {
            fetch(`/api/applications/${id}/${action}`, { method: 'PUT' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        alert("Success: " + d.message);
                        fetchApplications(); // Reload
                    } else {
                        alert("Error: " + d.message);
                    }
                });
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        // Init
        fetchApplications(); // Load data initially to populate stats
    </script>
</body>

</html>